
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_examples/02_deeplearning/01_example_plot_saliency_map.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_auto_examples_02_deeplearning_01_example_plot_saliency_map.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_02_deeplearning_01_example_plot_saliency_map.py:


Example: Plot Saliency Map
==========================

.. GENERATED FROM PYTHON SOURCE LINES 5-10

.. code-block:: Python


    # Authors: Simon Kojima <simon.kojima@inria.fr>
    #
    # License: BSD (3-clause)








.. GENERATED FROM PYTHON SOURCE LINES 11-13

Import Packages
===============

.. GENERATED FROM PYTHON SOURCE LINES 13-26

.. code-block:: Python

    import functools
    from pathlib import Path
    import numpy as np
    import mne
    import torch
    import braindecode
    import rosoku
    import msgpack
    from moabb.datasets import Dreyer2023
    import matplotlib.pyplot as plt
    import seaborn as sns









.. GENERATED FROM PYTHON SOURCE LINES 27-29

Define callback functions
=========================

.. GENERATED FROM PYTHON SOURCE LINES 29-100

.. code-block:: Python

    def callback_get_model(X, y):
        _, n_chans, n_times = X.shape
        F1 = 4
        D = 2
        F2 = F1 * D

        model = braindecode.models.EEGNet(
            n_chans=n_chans,
            n_outputs=2,
            n_times=n_times,
            F1=F1,
            D=D,
            F2=F2,
            drop_prob=0.5,
        )

        return model


    def callback_load_epochs(
        items, split, dataset, l_freq, h_freq, order_filter, tmin, tmax
    ):
        subject = items[0]
        items = items[1:]

        sessions = dataset.get_data(subjects=[subject])
        raws_dict = sessions[subject]["0"]

        epochs_list = []

        for name_run, raw in raws_dict.items():
            if not True in [item in name_run for item in items]:
                continue

            raw.filter(
                l_freq=l_freq,
                h_freq=h_freq,
                method="iir",
                iir_params={"ftype": "butter", "order": order_filter, "btype": "bandpass"},
            )

            raw = raw.pick(picks="eeg")

            epochs = mne.Epochs(
                raw=raw,
                tmin=tmin,
                tmax=tmax,
                baseline=None,
            )

            epochs_list.append(epochs)

        return mne.concatenate_epochs(epochs_list)


    def callback_proc_epochs(epochs, split):
        # do nothing in this example
        return epochs


    def convert_epochs_to_ndarray(
        epochs,
        split,
        label_keys,
    ):
        X = epochs.get_data()
        y = rosoku.utils.get_labels_from_epochs(epochs, label_keys)

        return X, y









.. GENERATED FROM PYTHON SOURCE LINES 101-103

Run the Experiment
==================

.. GENERATED FROM PYTHON SOURCE LINES 103-173

.. code-block:: Python


    subject = 56
    resample = 128

    lr = 1e-3
    weight_decay = 1e-2
    n_epochs = 100
    batch_size = 8
    patience = 75
    enable_normalization = True
    device = "cuda" if torch.cuda.is_available() else "cpu"

    seed = 42

    dataset = Dreyer2023()

    save_base = Path("~").expanduser() / "rosoku-log"
    (save_base / "checkpoint").mkdir(parents=True, exist_ok=True)
    (save_base / "history").mkdir(parents=True, exist_ok=True)
    (save_base / "saliency").mkdir(parents=True, exist_ok=True)
    (save_base / "samples").mkdir(parents=True, exist_ok=True)
    (save_base / "normalization").mkdir(parents=True, exist_ok=True)

    criterion = torch.nn.CrossEntropyLoss()
    scheduler = torch.optim.lr_scheduler.CosineAnnealingLR
    scheduler_params = {"T_max": n_epochs, "eta_min": 1e-6}
    optimizer = torch.optim.AdamW
    optimizer_params = {"lr": lr, "weight_decay": weight_decay}
    early_stopping = rosoku.utils.EarlyStopping(patience=patience)

    label_keys = {"left_hand": 0, "right_hand": 1}

    results = rosoku.deeplearning(
        items_train=[subject, "R1", "R2"],
        items_valid=[subject, "R3"],
        items_test=[[subject, "R4", "R5"]],
        callback_load_epochs=functools.partial(
            callback_load_epochs,
            dataset=dataset,
            l_freq=8.0,
            h_freq=30.0,
            order_filter=4,
            tmin=dataset.interval[0] + 0.5,
            tmax=dataset.interval[1],
        ),
        callback_proc_epochs=callback_proc_epochs,
        callback_convert_epochs_to_ndarray=functools.partial(
            convert_epochs_to_ndarray, label_keys=label_keys
        ),
        batch_size=batch_size,
        n_epochs=n_epochs,
        criterion=criterion,
        optimizer=optimizer,
        optimizer_params=optimizer_params,
        callback_get_model=callback_get_model,
        scheduler=scheduler,
        scheduler_params=scheduler_params,
        device=device,
        early_stopping=early_stopping,
        enable_normalization=enable_normalization,
        history_fname=(save_base / "history" / f"sub-{subject}.parquet"),
        checkpoint_fname=(save_base / "checkpoint" / f"sub-{subject}.pth"),
        samples_fname=(save_base / "samples" / f"sub-{subject}.parquet"),
        normalization_fname=(save_base / "normalization" / f"sub-{subject}.msgpack"),
        saliency_map_fname=(save_base / "saliency" / f"sub-{subject}.msgpack"),
        label_keys=label_keys,
        seed=seed,
        additional_values={"subject": subject},
    )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    0it [00:00, ?it/s]    9it [00:00, 21100.47it/s]
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Filtering raw data in 1 contiguous segment
    Setting up band-pass filter from 8 - 30 Hz

    IIR filter parameters
    ---------------------
    Butterworth bandpass zero-phase (two-pass forward and reverse) non-causal filter:
    - Filter order 16 (effective, after forward-backward)
    - Cutoffs at 8.00, 30.00 Hz: -6.02, -6.02 dB

    Used Annotations descriptions: [np.str_('left_hand'), np.str_('right_hand')]
    Ignoring annotation durations and creating fixed-duration epochs around annotation onsets.
    Not setting metadata
    40 matching events found
    No baseline correction applied
    0 projection items activated
    Filtering raw data in 1 contiguous segment
    Setting up band-pass filter from 8 - 30 Hz

    IIR filter parameters
    ---------------------
    Butterworth bandpass zero-phase (two-pass forward and reverse) non-causal filter:
    - Filter order 16 (effective, after forward-backward)
    - Cutoffs at 8.00, 30.00 Hz: -6.02, -6.02 dB

    Used Annotations descriptions: [np.str_('left_hand'), np.str_('right_hand')]
    Ignoring annotation durations and creating fixed-duration epochs around annotation onsets.
    Not setting metadata
    40 matching events found
    No baseline correction applied
    0 projection items activated
    /home/skojima/git/rosoku/examples/02_deeplearning/01_example_plot_saliency_map.py:81: RuntimeWarning: Concatenation of Annotations within Epochs is not supported yet. All annotations will be dropped.
      return mne.concatenate_epochs(epochs_list)
    Using data from preloaded Raw for 40 events and 2305 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 40 events and 2305 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 40 events and 2305 original time points ...
    Using data from preloaded Raw for 40 events and 2305 original time points ...
    Not setting metadata
    80 matching events found
    No baseline correction applied
    0it [00:00, ?it/s]    9it [00:00, 22231.29it/s]
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Filtering raw data in 1 contiguous segment
    Setting up band-pass filter from 8 - 30 Hz

    IIR filter parameters
    ---------------------
    Butterworth bandpass zero-phase (two-pass forward and reverse) non-causal filter:
    - Filter order 16 (effective, after forward-backward)
    - Cutoffs at 8.00, 30.00 Hz: -6.02, -6.02 dB

    Used Annotations descriptions: [np.str_('left_hand'), np.str_('right_hand')]
    Ignoring annotation durations and creating fixed-duration epochs around annotation onsets.
    Not setting metadata
    40 matching events found
    No baseline correction applied
    0 projection items activated
    /home/skojima/git/rosoku/examples/02_deeplearning/01_example_plot_saliency_map.py:81: RuntimeWarning: Concatenation of Annotations within Epochs is not supported yet. All annotations will be dropped.
      return mne.concatenate_epochs(epochs_list)
    Using data from preloaded Raw for 40 events and 2305 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 40 events and 2305 original time points ...
    Not setting metadata
    40 matching events found
    No baseline correction applied
    0it [00:00, ?it/s]    9it [00:00, 22536.56it/s]
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Filtering raw data in 1 contiguous segment
    Setting up band-pass filter from 8 - 30 Hz

    IIR filter parameters
    ---------------------
    Butterworth bandpass zero-phase (two-pass forward and reverse) non-causal filter:
    - Filter order 16 (effective, after forward-backward)
    - Cutoffs at 8.00, 30.00 Hz: -6.02, -6.02 dB

    Used Annotations descriptions: [np.str_('left_hand'), np.str_('right_hand')]
    Ignoring annotation durations and creating fixed-duration epochs around annotation onsets.
    Not setting metadata
    40 matching events found
    No baseline correction applied
    0 projection items activated
    Filtering raw data in 1 contiguous segment
    Setting up band-pass filter from 8 - 30 Hz

    IIR filter parameters
    ---------------------
    Butterworth bandpass zero-phase (two-pass forward and reverse) non-causal filter:
    - Filter order 16 (effective, after forward-backward)
    - Cutoffs at 8.00, 30.00 Hz: -6.02, -6.02 dB

    Used Annotations descriptions: [np.str_('left_hand'), np.str_('right_hand')]
    Ignoring annotation durations and creating fixed-duration epochs around annotation onsets.
    Not setting metadata
    40 matching events found
    No baseline correction applied
    0 projection items activated
    /home/skojima/git/rosoku/examples/02_deeplearning/01_example_plot_saliency_map.py:81: RuntimeWarning: Concatenation of Annotations within Epochs is not supported yet. All annotations will be dropped.
      return mne.concatenate_epochs(epochs_list)
    Using data from preloaded Raw for 40 events and 2305 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 40 events and 2305 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 40 events and 2305 original time points ...
    Using data from preloaded Raw for 40 events and 2305 original time points ...
    Not setting metadata
    80 matching events found
    No baseline correction applied
    epoch 000, train_loss: 0.7022, train_acc: 0.56, valid_loss: 0.6935, valid_acc: 0.47, lr: 9.9975e-04, et: 0.0563, checkpoint saved
    epoch 001, train_loss: 0.7059, train_acc: 0.53, valid_loss: 0.6935, valid_acc: 0.42, lr: 9.9901e-04, et: 0.0574
    epoch 002, train_loss: 0.6519, train_acc: 0.62, valid_loss: 0.6940, valid_acc: 0.40, lr: 9.9778e-04, et: 0.0591
    epoch 003, train_loss: 0.6453, train_acc: 0.64, valid_loss: 0.6945, valid_acc: 0.42, lr: 9.9606e-04, et: 0.0585
    epoch 004, train_loss: 0.6090, train_acc: 0.68, valid_loss: 0.6945, valid_acc: 0.45, lr: 9.9385e-04, et: 0.0590
    epoch 005, train_loss: 0.5910, train_acc: 0.70, valid_loss: 0.6929, valid_acc: 0.53, lr: 9.9115e-04, et: 0.0584, checkpoint saved
    epoch 006, train_loss: 0.5268, train_acc: 0.82, valid_loss: 0.6922, valid_acc: 0.47, lr: 9.8797e-04, et: 0.0586, checkpoint saved
    epoch 007, train_loss: 0.4907, train_acc: 0.88, valid_loss: 0.6901, valid_acc: 0.45, lr: 9.8431e-04, et: 0.0582, checkpoint saved
    epoch 008, train_loss: 0.4714, train_acc: 0.84, valid_loss: 0.6838, valid_acc: 0.47, lr: 9.8017e-04, et: 0.0584, checkpoint saved
    epoch 009, train_loss: 0.3894, train_acc: 0.89, valid_loss: 0.6778, valid_acc: 0.57, lr: 9.7555e-04, et: 0.0592, checkpoint saved
    epoch 010, train_loss: 0.3667, train_acc: 0.94, valid_loss: 0.6710, valid_acc: 0.55, lr: 9.7047e-04, et: 0.0590, checkpoint saved
    epoch 011, train_loss: 0.2999, train_acc: 0.91, valid_loss: 0.6595, valid_acc: 0.57, lr: 9.6492e-04, et: 0.0592, checkpoint saved
    epoch 012, train_loss: 0.2532, train_acc: 0.94, valid_loss: 0.6630, valid_acc: 0.53, lr: 9.5892e-04, et: 0.0587
    epoch 013, train_loss: 0.2102, train_acc: 0.96, valid_loss: 0.6526, valid_acc: 0.53, lr: 9.5246e-04, et: 0.0585, checkpoint saved
    epoch 014, train_loss: 0.2174, train_acc: 0.95, valid_loss: 0.6465, valid_acc: 0.50, lr: 9.4556e-04, et: 0.0602, checkpoint saved
    epoch 015, train_loss: 0.1504, train_acc: 0.96, valid_loss: 0.6400, valid_acc: 0.53, lr: 9.3822e-04, et: 0.0609, checkpoint saved
    epoch 016, train_loss: 0.1535, train_acc: 0.96, valid_loss: 0.6186, valid_acc: 0.53, lr: 9.3044e-04, et: 0.0595, checkpoint saved
    epoch 017, train_loss: 0.0953, train_acc: 0.99, valid_loss: 0.6056, valid_acc: 0.55, lr: 9.2224e-04, et: 0.0596, checkpoint saved
    epoch 018, train_loss: 0.1188, train_acc: 0.96, valid_loss: 0.5824, valid_acc: 0.60, lr: 9.1363e-04, et: 0.0650, checkpoint saved
    epoch 019, train_loss: 0.1081, train_acc: 0.99, valid_loss: 0.5385, valid_acc: 0.62, lr: 9.0460e-04, et: 0.0650, checkpoint saved
    epoch 020, train_loss: 0.1214, train_acc: 0.96, valid_loss: 0.5101, valid_acc: 0.68, lr: 8.9518e-04, et: 0.0631, checkpoint saved
    epoch 021, train_loss: 0.1104, train_acc: 0.96, valid_loss: 0.4677, valid_acc: 0.70, lr: 8.8537e-04, et: 0.0609, checkpoint saved
    epoch 022, train_loss: 0.1052, train_acc: 0.97, valid_loss: 0.3935, valid_acc: 0.80, lr: 8.7518e-04, et: 0.0592, checkpoint saved
    epoch 023, train_loss: 0.0424, train_acc: 0.99, valid_loss: 0.3573, valid_acc: 0.85, lr: 8.6462e-04, et: 0.0589, checkpoint saved
    epoch 024, train_loss: 0.0608, train_acc: 0.99, valid_loss: 0.3000, valid_acc: 0.88, lr: 8.5370e-04, et: 0.0592, checkpoint saved
    epoch 025, train_loss: 0.0821, train_acc: 0.99, valid_loss: 0.2784, valid_acc: 0.88, lr: 8.4243e-04, et: 0.0610, checkpoint saved
    epoch 026, train_loss: 0.0705, train_acc: 0.99, valid_loss: 0.2802, valid_acc: 0.88, lr: 8.3083e-04, et: 0.0606
    epoch 027, train_loss: 0.0767, train_acc: 0.99, valid_loss: 0.2635, valid_acc: 0.90, lr: 8.1889e-04, et: 0.0599, checkpoint saved
    epoch 028, train_loss: 0.0635, train_acc: 0.99, valid_loss: 0.2782, valid_acc: 0.88, lr: 8.0665e-04, et: 0.0589
    epoch 029, train_loss: 0.0396, train_acc: 0.99, valid_loss: 0.2589, valid_acc: 0.90, lr: 7.9410e-04, et: 0.0593, checkpoint saved
    epoch 030, train_loss: 0.0510, train_acc: 0.99, valid_loss: 0.2100, valid_acc: 0.95, lr: 7.8126e-04, et: 0.0591, checkpoint saved
    epoch 031, train_loss: 0.0609, train_acc: 0.97, valid_loss: 0.2081, valid_acc: 0.95, lr: 7.6815e-04, et: 0.0593, checkpoint saved
    epoch 032, train_loss: 0.0316, train_acc: 1.00, valid_loss: 0.2110, valid_acc: 0.95, lr: 7.5477e-04, et: 0.0589
    epoch 033, train_loss: 0.0719, train_acc: 0.99, valid_loss: 0.1990, valid_acc: 0.95, lr: 7.4114e-04, et: 0.0595, checkpoint saved
    epoch 034, train_loss: 0.1987, train_acc: 0.94, valid_loss: 0.1771, valid_acc: 0.95, lr: 7.2727e-04, et: 0.0585, checkpoint saved
    epoch 035, train_loss: 0.1206, train_acc: 0.97, valid_loss: 0.1711, valid_acc: 0.97, lr: 7.1318e-04, et: 0.0566, checkpoint saved
    epoch 036, train_loss: 0.0447, train_acc: 1.00, valid_loss: 0.1643, valid_acc: 0.97, lr: 6.9888e-04, et: 0.0569, checkpoint saved
    epoch 037, train_loss: 0.0416, train_acc: 1.00, valid_loss: 0.1615, valid_acc: 0.95, lr: 6.8438e-04, et: 0.0561, checkpoint saved
    epoch 038, train_loss: 0.0403, train_acc: 1.00, valid_loss: 0.1569, valid_acc: 0.97, lr: 6.6970e-04, et: 0.0567, checkpoint saved
    epoch 039, train_loss: 0.1057, train_acc: 0.97, valid_loss: 0.1567, valid_acc: 0.93, lr: 6.5485e-04, et: 0.0565, checkpoint saved
    epoch 040, train_loss: 0.0315, train_acc: 0.99, valid_loss: 0.1513, valid_acc: 0.93, lr: 6.3986e-04, et: 0.0582, checkpoint saved
    epoch 041, train_loss: 0.0810, train_acc: 0.97, valid_loss: 0.1387, valid_acc: 0.95, lr: 6.2472e-04, et: 0.0598, checkpoint saved
    epoch 042, train_loss: 0.0897, train_acc: 0.97, valid_loss: 0.1381, valid_acc: 0.95, lr: 6.0946e-04, et: 0.0636, checkpoint saved
    epoch 043, train_loss: 0.0325, train_acc: 1.00, valid_loss: 0.1371, valid_acc: 0.95, lr: 5.9410e-04, et: 0.0580, checkpoint saved
    epoch 044, train_loss: 0.0849, train_acc: 0.96, valid_loss: 0.1548, valid_acc: 0.93, lr: 5.7864e-04, et: 0.0562
    epoch 045, train_loss: 0.0786, train_acc: 0.97, valid_loss: 0.1585, valid_acc: 0.93, lr: 5.6310e-04, et: 0.0578
    epoch 046, train_loss: 0.0192, train_acc: 1.00, valid_loss: 0.1451, valid_acc: 0.95, lr: 5.4751e-04, et: 0.0576
    epoch 047, train_loss: 0.0224, train_acc: 1.00, valid_loss: 0.1404, valid_acc: 0.95, lr: 5.3186e-04, et: 0.0580
    epoch 048, train_loss: 0.0185, train_acc: 1.00, valid_loss: 0.1372, valid_acc: 0.95, lr: 5.1619e-04, et: 0.0580
    epoch 049, train_loss: 0.0364, train_acc: 1.00, valid_loss: 0.1351, valid_acc: 0.97, lr: 5.0050e-04, et: 0.0575, checkpoint saved
    epoch 050, train_loss: 0.0369, train_acc: 0.99, valid_loss: 0.1328, valid_acc: 0.97, lr: 4.8481e-04, et: 0.0572, checkpoint saved
    epoch 051, train_loss: 0.0372, train_acc: 0.99, valid_loss: 0.1399, valid_acc: 0.95, lr: 4.6914e-04, et: 0.0567
    epoch 052, train_loss: 0.0266, train_acc: 1.00, valid_loss: 0.1423, valid_acc: 0.95, lr: 4.5349e-04, et: 0.0570
    epoch 053, train_loss: 0.0621, train_acc: 0.97, valid_loss: 0.1313, valid_acc: 0.95, lr: 4.3790e-04, et: 0.0573, checkpoint saved
    epoch 054, train_loss: 0.0669, train_acc: 0.96, valid_loss: 0.1423, valid_acc: 0.95, lr: 4.2236e-04, et: 0.0564
    epoch 055, train_loss: 0.0324, train_acc: 1.00, valid_loss: 0.1561, valid_acc: 0.93, lr: 4.0690e-04, et: 0.0568
    epoch 056, train_loss: 0.0375, train_acc: 1.00, valid_loss: 0.1630, valid_acc: 0.93, lr: 3.9154e-04, et: 0.0568
    epoch 057, train_loss: 0.0370, train_acc: 0.99, valid_loss: 0.1571, valid_acc: 0.95, lr: 3.7628e-04, et: 0.0570
    epoch 058, train_loss: 0.0159, train_acc: 1.00, valid_loss: 0.1599, valid_acc: 0.95, lr: 3.6114e-04, et: 0.0568
    epoch 059, train_loss: 0.0341, train_acc: 0.99, valid_loss: 0.1612, valid_acc: 0.95, lr: 3.4615e-04, et: 0.0569
    epoch 060, train_loss: 0.0633, train_acc: 0.97, valid_loss: 0.1713, valid_acc: 0.95, lr: 3.3130e-04, et: 0.0569
    epoch 061, train_loss: 0.0750, train_acc: 0.97, valid_loss: 0.1933, valid_acc: 0.93, lr: 3.1662e-04, et: 0.0600
    epoch 062, train_loss: 0.0522, train_acc: 0.97, valid_loss: 0.1875, valid_acc: 0.93, lr: 3.0212e-04, et: 0.0578
    epoch 063, train_loss: 0.0169, train_acc: 1.00, valid_loss: 0.1662, valid_acc: 0.95, lr: 2.8782e-04, et: 0.0580
    epoch 064, train_loss: 0.0163, train_acc: 1.00, valid_loss: 0.1541, valid_acc: 0.95, lr: 2.7373e-04, et: 0.0595
    epoch 065, train_loss: 0.1503, train_acc: 0.97, valid_loss: 0.1554, valid_acc: 0.95, lr: 2.5986e-04, et: 0.0571
    epoch 066, train_loss: 0.0227, train_acc: 1.00, valid_loss: 0.1528, valid_acc: 0.95, lr: 2.4623e-04, et: 0.0572
    epoch 067, train_loss: 0.0155, train_acc: 1.00, valid_loss: 0.1514, valid_acc: 0.95, lr: 2.3285e-04, et: 0.0580
    epoch 068, train_loss: 0.0149, train_acc: 1.00, valid_loss: 0.1470, valid_acc: 0.95, lr: 2.1974e-04, et: 0.0573
    epoch 069, train_loss: 0.0233, train_acc: 1.00, valid_loss: 0.1442, valid_acc: 0.95, lr: 2.0690e-04, et: 0.0577
    epoch 070, train_loss: 0.0110, train_acc: 1.00, valid_loss: 0.1411, valid_acc: 0.95, lr: 1.9435e-04, et: 0.0569
    epoch 071, train_loss: 0.0204, train_acc: 1.00, valid_loss: 0.1402, valid_acc: 0.95, lr: 1.8211e-04, et: 0.0573
    epoch 072, train_loss: 0.0376, train_acc: 0.99, valid_loss: 0.1413, valid_acc: 0.95, lr: 1.7017e-04, et: 0.0570
    epoch 073, train_loss: 0.0221, train_acc: 0.99, valid_loss: 0.1401, valid_acc: 0.95, lr: 1.5857e-04, et: 0.0581
    epoch 074, train_loss: 0.0261, train_acc: 1.00, valid_loss: 0.1372, valid_acc: 0.97, lr: 1.4730e-04, et: 0.0570
    epoch 075, train_loss: 0.0348, train_acc: 1.00, valid_loss: 0.1328, valid_acc: 0.97, lr: 1.3638e-04, et: 0.0570
    epoch 076, train_loss: 0.0208, train_acc: 1.00, valid_loss: 0.1304, valid_acc: 0.97, lr: 1.2582e-04, et: 0.0577, checkpoint saved
    epoch 077, train_loss: 0.0253, train_acc: 1.00, valid_loss: 0.1304, valid_acc: 0.97, lr: 1.1563e-04, et: 0.0565, checkpoint saved
    epoch 078, train_loss: 0.0260, train_acc: 0.99, valid_loss: 0.1319, valid_acc: 0.97, lr: 1.0582e-04, et: 0.0564
    epoch 079, train_loss: 0.0294, train_acc: 1.00, valid_loss: 0.1342, valid_acc: 0.97, lr: 9.6396e-05, et: 0.0583
    epoch 080, train_loss: 0.0087, train_acc: 1.00, valid_loss: 0.1354, valid_acc: 0.97, lr: 8.7373e-05, et: 0.0678
    epoch 081, train_loss: 0.1237, train_acc: 0.95, valid_loss: 0.1336, valid_acc: 0.97, lr: 7.8758e-05, et: 0.0673
    epoch 082, train_loss: 0.0267, train_acc: 0.99, valid_loss: 0.1342, valid_acc: 0.97, lr: 7.0559e-05, et: 0.0583
    epoch 083, train_loss: 0.0264, train_acc: 0.99, valid_loss: 0.1329, valid_acc: 0.97, lr: 6.2785e-05, et: 0.0585
    epoch 084, train_loss: 0.0566, train_acc: 0.97, valid_loss: 0.1317, valid_acc: 0.97, lr: 5.5442e-05, et: 0.0604
    epoch 085, train_loss: 0.0097, train_acc: 1.00, valid_loss: 0.1304, valid_acc: 0.97, lr: 4.8539e-05, et: 0.0598
    epoch 086, train_loss: 0.0290, train_acc: 1.00, valid_loss: 0.1305, valid_acc: 0.97, lr: 4.2082e-05, et: 0.0588
    epoch 087, train_loss: 0.0293, train_acc: 1.00, valid_loss: 0.1300, valid_acc: 0.97, lr: 3.6077e-05, et: 0.0568, checkpoint saved
    epoch 088, train_loss: 0.0181, train_acc: 1.00, valid_loss: 0.1299, valid_acc: 0.97, lr: 3.0530e-05, et: 0.0571, checkpoint saved
    epoch 089, train_loss: 0.0198, train_acc: 1.00, valid_loss: 0.1299, valid_acc: 0.97, lr: 2.5447e-05, et: 0.0564, checkpoint saved
    epoch 090, train_loss: 0.0485, train_acc: 0.99, valid_loss: 0.1293, valid_acc: 0.97, lr: 2.0833e-05, et: 0.0562, checkpoint saved
    epoch 091, train_loss: 0.0327, train_acc: 0.99, valid_loss: 0.1289, valid_acc: 0.97, lr: 1.6693e-05, et: 0.0621, checkpoint saved
    epoch 092, train_loss: 0.0148, train_acc: 1.00, valid_loss: 0.1284, valid_acc: 0.97, lr: 1.3030e-05, et: 0.0706, checkpoint saved
    epoch 093, train_loss: 0.0078, train_acc: 1.00, valid_loss: 0.1283, valid_acc: 0.97, lr: 9.8475e-06, et: 0.0615, checkpoint saved
    epoch 094, train_loss: 0.0377, train_acc: 0.99, valid_loss: 0.1280, valid_acc: 0.97, lr: 7.1497e-06, et: 0.0622, checkpoint saved
    epoch 095, train_loss: 0.0516, train_acc: 0.99, valid_loss: 0.1282, valid_acc: 0.97, lr: 4.9387e-06, et: 0.0585
    epoch 096, train_loss: 0.0493, train_acc: 0.97, valid_loss: 0.1284, valid_acc: 0.97, lr: 3.2168e-06, et: 0.0597
    epoch 097, train_loss: 0.0254, train_acc: 1.00, valid_loss: 0.1286, valid_acc: 0.97, lr: 1.9856e-06, et: 0.0595
    epoch 098, train_loss: 0.0389, train_acc: 0.99, valid_loss: 0.1284, valid_acc: 0.97, lr: 1.2465e-06, et: 0.0588
    epoch 099, train_loss: 0.0313, train_acc: 0.99, valid_loss: 0.1281, valid_acc: 0.97, lr: 1.0000e-06, et: 0.0774
    Elapsed Time: 6.06s




.. GENERATED FROM PYTHON SOURCE LINES 174-176

Print Results
=============

.. GENERATED FROM PYTHON SOURCE LINES 176-179

.. code-block:: Python


    print(results.to_string())





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

            items_train items_valid        items_test  accuracy   model  subject
    0  [56, "R1", "R2"]  [56, "R3"]  [56, "R4", "R5"]    0.9875  EEGNet       56




.. GENERATED FROM PYTHON SOURCE LINES 180-182

Load Saliency Map Data
======================

.. GENERATED FROM PYTHON SOURCE LINES 182-186

.. code-block:: Python


    with open(save_base / "saliency" / f"sub-{subject}.msgpack", "rb") as f:
        saliency_map_data = msgpack.load(f, strict_map_key=False)








.. GENERATED FROM PYTHON SOURCE LINES 187-189

Plot Spatial Saliency
=====================

.. GENERATED FROM PYTHON SOURCE LINES 189-224

.. code-block:: Python


    spatial_saliency_left = rosoku.attribution.saliency_spatial(
        saliency_map_data[0]["left_hand"]
    )
    spatial_saliency_right = rosoku.attribution.saliency_spatial(
        saliency_map_data[0]["right_hand"]
    )

    # get channel position info
    raw = list(Dreyer2023().get_data(subjects=[subject])[subject]["0"].values())[0]
    ch_names = raw.pick(picks="eeg").ch_names
    montage = mne.channels.make_standard_montage("standard_1005")
    ch_pos = montage.get_positions()["ch_pos"]
    ch_pos = np.array([ch_pos[ch_name][:2] for ch_name in ch_names])

    fig, axes = plt.subplots(1, 2, figsize=(8, 5))

    axes[0].set_title("Left Hand")
    mne.viz.plot_topomap(
        spatial_saliency_left,
        ch_pos,
        names=None,
        cmap="seismic",
        axes=axes[0],
    )

    axes[1].set_title("Right Hand")
    mne.viz.plot_topomap(
        spatial_saliency_left,
        ch_pos,
        names=None,
        cmap="seismic",
        axes=axes[1],
    )




.. image-sg:: /auto_examples/02_deeplearning/images/sphx_glr_01_example_plot_saliency_map_001.png
   :alt: Left Hand, Right Hand
   :srcset: /auto_examples/02_deeplearning/images/sphx_glr_01_example_plot_saliency_map_001.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    0it [00:00, ?it/s]    9it [00:00, 20729.67it/s]
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...
    Reading 0 ... 230911  =      0.000 ...   450.998 secs...

    (<matplotlib.image.AxesImage object at 0x721d01ee6610>, <matplotlib.contour.QuadContourSet object at 0x721cef3c34d0>)



.. GENERATED FROM PYTHON SOURCE LINES 225-227

Plot Temporal Saliency
======================

.. GENERATED FROM PYTHON SOURCE LINES 227-243

.. code-block:: Python


    temporal_saliency_left = rosoku.attribution.saliency_temporal(
        saliency_map_data[0]["left_hand"]
    )
    temporal_saliency_right = rosoku.attribution.saliency_temporal(
        saliency_map_data[0]["right_hand"]
    )

    fig, axes = plt.subplots(1, 2, figsize=(10, 5))

    sns.set()
    sns.lineplot(temporal_saliency_left, ax=axes[0])
    sns.lineplot(temporal_saliency_right, ax=axes[1])

    axes[0].set_title("Left Hand")
    axes[1].set_title("Right Hand")



.. image-sg:: /auto_examples/02_deeplearning/images/sphx_glr_01_example_plot_saliency_map_002.png
   :alt: Left Hand, Right Hand
   :srcset: /auto_examples/02_deeplearning/images/sphx_glr_01_example_plot_saliency_map_002.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    Text(0.5, 1.0, 'Right Hand')




.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 8.826 seconds)


.. _sphx_glr_download_auto_examples_02_deeplearning_01_example_plot_saliency_map.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: 01_example_plot_saliency_map.ipynb <01_example_plot_saliency_map.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: 01_example_plot_saliency_map.py <01_example_plot_saliency_map.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: 01_example_plot_saliency_map.zip <01_example_plot_saliency_map.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
